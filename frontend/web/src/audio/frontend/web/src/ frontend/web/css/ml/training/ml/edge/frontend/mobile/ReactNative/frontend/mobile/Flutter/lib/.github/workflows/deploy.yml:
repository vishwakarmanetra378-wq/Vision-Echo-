name: Deploy Vision-Echo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  AZURE_FUNCTIONAPP_NAME: visionecho-functions
  AZURE_FUNCTIONAPP_PACKAGE_PATH: './backend/functions'
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.9'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install Dependencies
        run: |
          cd backend/functions && npm ci
          cd ../python && pip install -r requirements.txt
          cd ../../frontend/web && npm ci
          
      - name: Run Tests
        run: |
          cd backend/functions && npm test
          cd ../python && python -m pytest tests/
          cd ../../frontend/web && npm test
          
      - name: Lint Code
        run: |
          cd backend/functions && npm run lint
          cd ../../frontend/web && npm run lint

  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
      
      - name: Build Docker Images
        run: |
          docker build -t visionecho/functions ./backend/functions
          docker build -t visionecho/web ./frontend/web
          docker build -t visionecho/ml ./ml
          
      - name: Save Docker Images
        run: |
          docker save visionecho/functions -o functions.tar
          docker save visionecho/web -o web.tar
          docker save visionecho/ml -o ml.tar
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: docker-images
          path: |
            functions.tar
            web.tar
            ml.tar

  deploy-azure:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v3
      
      - name: Download Artifacts
        uses: actions/download-artifact@v3
        with:
          name: docker-images
          
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Deploy to Azure Functions
        uses: azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
          
      - name: Deploy to Azure Container Registry
        run: |
          az acr login --name ${{ secrets.ACR_REGISTRY }}
          docker load -i functions.tar
          docker tag visionecho/functions ${{ secrets.ACR_REGISTRY }}/functions:${{ github.sha }}
          docker push ${{ secrets.ACR_REGISTRY }}/functions:${{ github.sha }}
          
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: visionecho-web
          images: ${{ secrets.ACR_REGISTRY }}/web:${{ github.sha }}
          
      - name: Deploy ML Model
        run: |
          az ml model deploy \
            --name visionecho-model \
            --model-path ./ml/models \
            --workspace-name ${{ secrets.AZURE_ML_WORKSPACE }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}
